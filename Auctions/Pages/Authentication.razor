@using Domain.Repository
@using Model.Entity
@using Services
@inject IUserRepository _repository
@inject NavigationManager _navigationManager
@inject AuthenticationStateProvider AuthProvider

<div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content clearfix">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
            <div class="modal-body">
                <EditForm Model="Login" OnSubmit="ExecuteLogin">
                    <h3 class="title">Login</h3>
                    <p class="description">Login here Using Email & Password</p>
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <Validator @ref="LoginValidator" />

                    <div class="form-group">
                        <span class="input-icon"><i class="fa fa-user"></i></span>
                        <input type="text" @bind-value="Login.Identifier" class="form-control" placeholder="Identifier">
                    </div>
                    <div class="form-group">
                        <span class="input-icon"><i class="fas fa-key"></i></span>
                        <input type="password" @bind-value="Login.Password" class="form-control" placeholder="Password">
                    </div>
                    <div style="display: flex; justify-content: space-between; ">
                        <div class="col">
                            <a href="" class="forgot-pass">Forgot Password?</a>
                        </div>
                        <div class="col">
                            <a data-dismiss="modal" data-toggle="modal" class="forgot-pass" href="#myModal2">Need an account?</a>
                        </div>
                    </div>
                    <button class="btn">Login</button>
                </EditForm>
            </div>
        </div>
    </div>
</div>



<!-- Modal -->
<div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content clearfix">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
            <div class="modal-body">
                <EditForm Model="Register" OnSubmit="ExecuteRegister">
                    <h3 class="title">Registration</h3>
                    <p class="description">Registrate here Using Email & Password </p>
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <Validator @ref="RegisterValidator" />
                    <div class="form-group">
                        <span class="input-icon"><i class="fa fa-user"></i></span>
                        <input type="text" @bind-value="Register.Username" class="form-control" placeholder="Type username">
                    </div>
                    <div class="form-group">
                        <span class="input-icon"><i class="fa fa-envelope"></i></span>
                        <input type="email" @bind-value="Register.Email" class="form-control" placeholder="Type email">
                    </div>
                    <div class="form-group">
                        <span class="input-icon"><i class="fas fa-key"></i></span>
                        <input type="password" @bind-value="Register.Password" class="form-control" placeholder="Password">
                    </div>
                    <div class="form-group">
                        <span class="input-icon"><i class="fas fa-key"></i></span>
                        <input type="password" @bind-value="Register.RepeatPassword" class="form-control" placeholder="Repeat Password">
                    </div>
                    <a data-dismiss="modal" data-toggle="modal" href="#myModal1" class="forgot-pass pull-right">Already have an account?</a>
                    <button class="btn">Register</button>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    IAuthService Auth;

    public LoginForm Login { get; set; } = new LoginForm();
    public Validator LoginValidator { get; set; }

    public RegisterForm Register { get; set; } = new RegisterForm();
    public Validator RegisterValidator { get; set; }

    protected override Task OnInitializedAsync() {
        Login = new LoginForm();
        Register = new RegisterForm();
        Auth = ((IAuthService)AuthProvider);
        return base.OnInitializedAsync();
    }

    private async Task ExecuteLogin(EditContext context) {
        await Auth.Login(Login);
        try {
            LoginValidator.Clear();
            if (!context.Validate()) return;
            else if (await Auth.Login(Login.Identifier, Login.Password)) _navigationManager.NavigateTo("/", forceLoad: true);
        } catch (Exception e) {
            LoginValidator.DisplayErrors(new Dictionary<string, List<string>>() { { "Account", new List<string>() { e.Message } } });
        }
    }

    private async Task ExecuteRegister(EditContext context) {
        try {
            if ((await _repository.FilterAsync(u => u.Username.ToUpper() == Register.Username.ToUpper())).Any()) RegisterValidator.DisplayErrors(new Dictionary<string, List<string>>() { { "Username", new List<string>() { "Username is already in use!" } } });
            else if ((await _repository.FilterAsync(u => u.Email.ToUpper() == Register.Email.ToUpper())).Any()) RegisterValidator.DisplayErrors(new Dictionary<string, List<string>>() { { "Email", new List<string>() { "Email is already in use!" } } });
            else if(Register.Password != Register.RepeatPassword) RegisterValidator.DisplayErrors(new Dictionary<string, List<string>>() { { "Password", new List<string>() { "Passwords do not match!" } } });
            else {
                User user = new User() {
                        Username = Register.Username,
                        Email = Register.Email,
                        Password = Register.Password
                    };
                user = await _repository.CreateAsync(user);
                _navigationManager.NavigateTo("");
            }
        } catch (Exception e) {
            Console.WriteLine(e.ToString());
        }
    }

    public class RegisterForm {
        public string Username { get; set; }
        public string Email { get; set; }
        public string Password { get; set; }
        public string RepeatPassword { get; set; }
    }

    public class LoginForm {
        public string Identifier { get; set; }
        public string Password { get; set; }
    }
}